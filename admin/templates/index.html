<!DOCTYPE html>
<html>
<head>
    <title>OpenVPN Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <div class="header">
        <h1>ğŸ” OpenVPN Admin</h1>
        <a href="/logout" class="btn-logout">ğŸšª Cerrar sesiÃ³n</a>
    </div>

    <!-- Connected Clients -->
    <div class="card">
        <div class="collapsible-header" onclick="toggleSection('connectedSection')">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="collapse-icon collapsed" id="connectedSection-icon">â–¼</span>
                <h2>ğŸ“¡ Clientes Conectados <span id="connectedCount" class="count-badge"></span></h2>
            </div>
            <button class="btn-small btn-secondary" id="btnRefreshConnected" onclick="event.stopPropagation(); loadConnected()">ğŸ”„</button>
        </div>
        <div class="collapsible-content collapsed" id="connectedSection">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Grupo</th>
                        <th>IP VPN</th>
                        <th>IP Real</th>
                        <th>Conectado</th>
                        <th>TrÃ¡fico</th>
                    </tr>
                </thead>
                <tbody id="connectedList">
                    <tr><td colspan="6" style="color:#666">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Rejected Clients -->
    <div class="card" id="rejectedCard" style="display:none;">
        <div class="collapsible-header" onclick="toggleSection('rejectedSection')">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="collapse-icon collapsed" id="rejectedSection-icon">â–¼</span>
                <h2>ğŸš« Clientes Rechazados <span id="rejectedCount" class="count-badge count-danger"></span></h2>
            </div>
            <button class="btn-small btn-secondary" onclick="event.stopPropagation(); loadRejected()">ğŸ”„</button>
        </div>
        <div class="collapsible-content collapsed" id="rejectedSection">
            <p class="info-text">Clientes bloqueados por no tener archivo CCD vÃ¡lido (revocados o inexistentes)</p>
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>IP Real</th>
                        <th>Ãšltimo Intento</th>
                        <th>Motivo</th>
                    </tr>
                </thead>
                <tbody id="rejectedList">
                    <tr><td colspan="4" style="color:#666">Cargando...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Grid: Groups + Create/Revoke -->
    <div class="grid">
        <div>
            <div class="card">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2>ğŸ“ Grupos</h2>
                    <button class="btn-small" onclick="showCreateGroupModal()">+ Nuevo Grupo</button>
                </div>
                <div id="groupsList"></div>
            </div>
        </div>
        <div>
            <div class="card">
                <h2>â• Crear Cliente</h2>
                <p class="info-text">Los clientes del mismo grupo pueden verse entre sÃ­. Admins ven todo.</p>
                <form id="createForm">
                    <input type="text" id="clientName" placeholder="Nombre (ej: gw-oficina, tecnico-juan)" required>
                    <select id="clientGroup" required>
                        <option value="">-- Seleccionar grupo --</option>
                    </select>
                    <input type="password" id="caPassword" placeholder="ContraseÃ±a de la CA" required>
                    <button type="submit">Crear Cliente</button>
                </form>
                <div id="createStatus" class="status"></div>
            </div>

            <div class="card">
                <h2>âš ï¸ Revocar Cliente</h2>
                <form id="revokeForm">
                    <input type="text" id="revokeClientName" placeholder="Nombre del cliente" required>
                    <input type="password" id="revokePassword" placeholder="ContraseÃ±a de la CA" required>
                    <button type="submit" class="btn-danger">Revocar</button>
                </form>
                <div id="revokeStatus" class="status"></div>
            </div>
        </div>
    </div>

    <!-- Clients by Group -->
    <div class="card">
        <div class="collapsible-header" onclick="toggleSection('clientsSection')">
            <div style="display:flex; align-items:center; gap:10px;">
                <span class="collapse-icon" id="clientsSection-icon">â–¼</span>
                <h2>ğŸ“‹ Clientes por Grupo <span id="clientsCount" class="count-badge"></span></h2>
            </div>
            <button class="btn-small btn-secondary" id="btnRefreshClients" onclick="event.stopPropagation(); loadClients()">ğŸ”„</button>
        </div>
        <div class="collapsible-content" id="clientsSection">
            <div id="clientsByGroup"></div>
        </div>
    </div>

    <!-- Modal: Create Group -->
    <div id="modalCreateGroup" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>â• Nuevo Grupo</h2>
                <button class="modal-close" onclick="hideModal('modalCreateGroup')">&times;</button>
            </div>
            <form id="createGroupForm">
                <label class="info-text">Nombre del grupo:</label>
                <input type="text" id="groupName" placeholder="Ej: Empresa ABC, FÃ¡brica Norte" required>
                
                <label class="info-text">Icono:</label>
                <div class="icon-picker" id="iconPicker">
                    <span class="icon-option selected" data-icon="ğŸ¢">ğŸ¢</span>
                    <span class="icon-option" data-icon="ğŸ­">ğŸ­</span>
                    <span class="icon-option" data-icon="ğŸ¬">ğŸ¬</span>
                    <span class="icon-option" data-icon="ğŸª">ğŸª</span>
                    <span class="icon-option" data-icon="ğŸ¥">ğŸ¥</span>
                    <span class="icon-option" data-icon="ğŸ«">ğŸ«</span>
                    <span class="icon-option" data-icon="ğŸ¨">ğŸ¨</span>
                    <span class="icon-option" data-icon="ğŸ¦">ğŸ¦</span>
                    <span class="icon-option" data-icon="âš¡">âš¡</span>
                    <span class="icon-option" data-icon="ğŸŒ">ğŸŒ</span>
                    <span class="icon-option" data-icon="ğŸ”§">ğŸ”§</span>
                    <span class="icon-option" data-icon="ğŸ“¡">ğŸ“¡</span>
                </div>
                
                <label class="info-text">Rango de IPs asignado:</label>
                <div class="range-preview" id="groupRangePreview">Cargando...</div>
                <p class="info-text">Cada grupo puede tener hasta 12 clientes.</p>
                
                <button type="submit">Crear Grupo</button>
            </form>
        </div>
    </div>

    <!-- Modal: Edit Group -->
    <div id="modalEditGroup" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœï¸ Editar Grupo</h2>
                <button class="modal-close" onclick="hideModal('modalEditGroup')">&times;</button>
            </div>
            <form id="editGroupForm">
                <input type="hidden" id="editGroupId">
                <label class="info-text">Nombre del grupo:</label>
                <input type="text" id="editGroupName" placeholder="Nombre del grupo" required>
                
                <label class="info-text">Icono:</label>
                <div class="icon-picker" id="editIconPicker">
                    <span class="icon-option" data-icon="ğŸ¢">ğŸ¢</span>
                    <span class="icon-option" data-icon="ğŸ­">ğŸ­</span>
                    <span class="icon-option" data-icon="ğŸ¬">ğŸ¬</span>
                    <span class="icon-option" data-icon="ğŸª">ğŸª</span>
                    <span class="icon-option" data-icon="ğŸ¥">ğŸ¥</span>
                    <span class="icon-option" data-icon="ğŸ«">ğŸ«</span>
                    <span class="icon-option" data-icon="ğŸ¨">ğŸ¨</span>
                    <span class="icon-option" data-icon="ğŸ¦">ğŸ¦</span>
                    <span class="icon-option" data-icon="âš¡">âš¡</span>
                    <span class="icon-option" data-icon="ğŸŒ">ğŸŒ</span>
                    <span class="icon-option" data-icon="ğŸ”§">ğŸ”§</span>
                    <span class="icon-option" data-icon="ğŸ“¡">ğŸ“¡</span>
                </div>
                
                <button type="submit">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script src="/static/js/app.js"></script>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-main">Â© 2026 <strong>WeDo IoT Solutions</strong></div>
        <div class="footer-sub">Desarrollado por Guillermo Ferrucci</div>
    </footer>
</body>
</html>
