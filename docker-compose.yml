services:
  openvpn:
    image: kylemanna/openvpn
    container_name: openvpn
    restart: always
    cap_add:
      - NET_ADMIN
    ports:
      - "1194:1194/udp"
    volumes:
      - openvpn_openvpn_data:/etc/openvpn
      - ./ccd:/etc/openvpn/ccd
    # ==========================================================================
    # Reglas iptables para aislamiento entre grupos - Subred /16
    # ==========================================================================
    # Subred: 10.8.0.0/16
    # - Admin (10.8.0.x): puede ver todo
    # - Grupos N (10.8.N.x): cada uno es un /24 aislado (1-255)
    # ==========================================================================
    command: >
      sh -c "
        echo '=== Configurando reglas de aislamiento VPN (Subred /16) ===';
        
        # Admin (10.8.0.0/24) puede comunicarse con todos
        iptables -A FORWARD -s 10.8.0.0/24 -j ACCEPT;
        iptables -A FORWARD -d 10.8.0.0/24 -j ACCEPT;
        
        echo 'Admin (10.8.0.0/24) puede ver todo';
        
        # Generar reglas para cada grupo (1-255)
        # Cada grupo es 10.8.N.0/24
        
        GROUP_COUNT=0;
        for GROUP_ID in $$(seq 1 255); do
          iptables -A FORWARD -s 10.8.$$GROUP_ID.0/24 -d 10.8.$$GROUP_ID.0/24 -j ACCEPT;
          GROUP_COUNT=$$((GROUP_COUNT + 1));
        done;
        
        echo \"Configurados $$GROUP_COUNT grupos (cada uno /24)\";
        
        # Bloquear trafico entre diferentes grupos
        iptables -A FORWARD -s 10.8.0.0/16 -d 10.8.0.0/16 -j DROP;
        
        echo 'Reglas de aislamiento configuradas correctamente (Subred /16)';
        ovpn_run
      "

  openvpn-admin:
    build: ./admin
    container_name: openvpn-admin
    restart: always
    ports:
      - "8888:8080"
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
      - SECRET_KEY=${SECRET_KEY:-simple_secret}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./clients:/app/clients
      - ./ccd:/app/ccd
    depends_on:
      - openvpn

volumes:
  openvpn_openvpn_data:
    external: true
