services:
  openvpn:
    image: kylemanna/openvpn
    container_name: openvpn
    restart: always
    cap_add:
      - NET_ADMIN
    ports:
      - "1194:1194/udp"
    volumes:
      - openvpn_openvpn_data:/etc/openvpn
      - ./ccd:/etc/openvpn/ccd
    # Reglas iptables para aislamiento entre grupos:
    # - Admin (4-13): puede ver todo - 10 IPs
    # - Grupos (20-39, 40-59, 60-79, etc): 20 IPs cada uno, aislados entre si
    command: >
      sh -c "
        # Admin (4-13) puede comunicarse con todos
        iptables -A FORWARD -m iprange --src-range 192.168.255.4-192.168.255.13 -j ACCEPT;
        iptables -A FORWARD -m iprange --dst-range 192.168.255.4-192.168.255.13 -j ACCEPT;
        
        # Permitir trafico dentro de cada grupo de 20 IPs (20-39, 40-59, ..., 220-239)
        for START in 20 40 60 80 100 120 140 160 180 200 220; do
          END=\$$((START + 19));
          iptables -A FORWARD -m iprange --src-range 192.168.255.\$${START}-192.168.255.\$${END} -m iprange --dst-range 192.168.255.\$${START}-192.168.255.\$${END} -j ACCEPT;
        done;
        
        # Bloquear trafico entre diferentes grupos (20-239)
        iptables -A FORWARD -m iprange --src-range 192.168.255.20-192.168.255.239 -m iprange --dst-range 192.168.255.20-192.168.255.239 -j DROP;
        
        ovpn_run
      "

  openvpn-admin:
    build: ./admin
    container_name: openvpn-admin
    restart: always
    ports:
      - "8888:8080"
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-SecurePassword123}  # Cambiar por una contrase√±a segura
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/bin/docker:/usr/bin/docker:ro
      - ./clients:/app/clients
      - ./ccd:/app/ccd
    depends_on:
      - openvpn

volumes:
  openvpn_openvpn_data:
    external: true
